# キーワードマイグレーション手順

このドキュメントでは、`Keyword`クラスを削除し、キーワード機能を`Article`クラスに統合するためのマイグレーション手順を説明します。

## 概要

現在のシステムでは、`Keyword`クラスと`Article`クラスが別々のテーブルとして存在し、`article_keywords`中間テーブルを介して多対多の関係を持っています。このマイグレーションでは、`Keyword`クラスを削除し、キーワード機能を`Article`クラスの`keywords`フィールド（カンマ区切りの文字列）に統合します。

## マイグレーション内容

1. 既存の`Article`と`Keyword`の関連を取得し、各記事に関連付けられたキーワードをカンマ区切りの文字列に変換して`Article.keywords`フィールドに保存
2. `article_keywords`中間テーブルを削除
3. `keywords`テーブルを削除
4. テンプレートとコードを修正して、新しいキーワード構造に対応

## 準備

マイグレーションを実行する前に、以下の準備を行ってください：

1. システムのバックアップを作成
2. アプリケーションを停止

## マイグレーション実行手順

### 1. マイグレーションスクリプトの実行

以下のコマンドを実行して、マイグレーションを実行します：

```bash
cd /path/to/rss_paper_server
python run_migration.py
```

このスクリプトは以下の処理を行います：

1. データベースのバックアップを作成
2. キーワードデータを移行
3. データベーススキーマを更新

### 2. マイグレーション結果の確認

マイグレーションが正常に完了したら、以下の点を確認してください：

1. `Article`テーブルの`keywords`フィールドにキーワードがカンマ区切りの文字列として保存されていること
2. `article_keywords`中間テーブルと`keywords`テーブルが削除されていること

### 3. アプリケーションの起動

マイグレーションが正常に完了したら、アプリケーションを起動します：

```bash
cd /path/to/rss_paper_server
python web_app.py
```

## トラブルシューティング

マイグレーション中にエラーが発生した場合は、以下の手順を試してください：

1. `migration.log`ファイルを確認して、エラーの原因を特定
2. バックアップからデータベースを復元
3. 問題を修正してマイグレーションを再実行

## 注意事項

- マイグレーション中はアプリケーションを停止してください
- マイグレーション前に必ずバックアップを作成してください
- マイグレーション後は、キーワード管理機能が変更されます（キーワード管理ページは削除され、フィードごとのフィルターキーワードのみ設定可能になります）

## 変更されたファイル

以下のファイルが変更されています：

1. `database.py` - `Keyword`クラスと`article_keywords`テーブルの削除、`Article`クラスの修正
2. `rss_fetcher.py` - キーワード処理の修正
3. `web_app.py` - キーワード関連のエンドポイントの削除、記事のフィルタリングロジックの修正
4. `templates/article_detail.html` - キーワード表示の修正
5. `templates/articles.html` - キーワード表示の修正

## マイグレーションスクリプト

以下のスクリプトが作成されています：

1. `migrate_keywords.py` - キーワードデータの移行
2. `update_schema.py` - データベーススキーマの更新
3. `run_migration.py` - マイグレーションの実行
